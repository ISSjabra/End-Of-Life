<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product End-of-Life Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Product End-of-Life Tracker</h1>
            <p class="text-md text-gray-600 mt-2">Select a product to see its version lifecycle details.</p>
        </header>

        <main>
            <!-- Product selection and filter section -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8 sticky top-4 bg-gray-50/90 backdrop-blur-sm p-4 rounded-lg shadow-sm">
                <div class="flex-grow">
                    <label for="product-select" class="block text-sm font-medium text-gray-700 mb-1">Select a Product:</label>
                    <select id="product-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option selected disabled>Loading products...</option>
                    </select>
                </div>
                <div class="flex-grow">
                    <label for="product-filter" class="block text-sm font-medium text-gray-700 mb-1">Or Filter Products:</label>
                    <input type="text" id="product-filter" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Type to filter...">
                </div>
                <div class="flex-grow">
                    <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                    <select id="status-filter" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="all" selected>All Statuses</option>
                        <option value="Supported">Supported</option>
                        <option value="End of Life">End of Life</option>
                        <option value="Not Yet Scheduled">Not Yet Scheduled</option>
                    </select>
                </div>
                 <div class="flex-grow">
                    <label for="version-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Version:</label>
                    <input type="text" id="version-filter" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., 18.04 or 10">
                </div>
                <div class="flex-grow flex items-end">
                    <button id="clear-filters-btn" class="w-full p-3 bg-red-500 text-white rounded-lg shadow-sm hover:bg-red-600 transition font-semibold">Clear All</button>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="loader" class="loader hidden"></div>
            
            <!-- Area to display product details -->
            <div id="product-details" class="mt-6">
                <!-- Product cycle info will be injected here -->
            </div>
             <!-- Initial message -->
            <div id="initial-message" class="text-center text-gray-500 p-10 border-2 border-dashed border-gray-300 rounded-lg">
                <p>Please select a product from the dropdown above to view its details.</p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productSelect = document.getElementById('product-select');
            const productFilter = document.getElementById('product-filter');
            const statusFilter = document.getElementById('status-filter');
            const versionFilter = document.getElementById('version-filter');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const productDetailsContainer = document.getElementById('product-details');
            const loader = document.getElementById('loader');
            const initialMessage = document.getElementById('initial-message');
            
            let allProducts = [];
            let currentProductCycles = [];

            const populateProductDropdown = (products) => {
                const currentVal = productSelect.value;
                productSelect.innerHTML = '<option selected disabled>Select a product</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
                if (products.includes(currentVal)) {
                    productSelect.value = currentVal;
                }
            };

            const fetchProductDetails = async (productName) => {
                if (!productName) return;
                loader.classList.remove('hidden');
                initialMessage.classList.add('hidden');
                productDetailsContainer.innerHTML = '';
                try {
                    const response = await fetch(`https://endoflife.date/api/${productName}.json`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    currentProductCycles = await response.json(); // Store cycles globally
                    renderProductDetails(productName); // Render details
                } catch (error) {
                    console.error(`Failed to fetch details for ${productName}:`, error);
                    productDetailsContainer.innerHTML = `<div class="text-center text-red-500 p-10 border-2 border-dashed border-red-300 rounded-lg"><p>Could not fetch details for "${productName}". Please try another product.</p></div>`;
                } finally {
                    loader.classList.add('hidden');
                }
            };

            const renderProductDetails = (productName) => {
                productDetailsContainer.innerHTML = ''; // Clear previous renders

                const selectedStatus = statusFilter.value;
                const versionQuery = versionFilter.value.toLowerCase();

                let filteredCycles = currentProductCycles;

                // Filter by status if not 'all'
                if (selectedStatus !== 'all') {
                    filteredCycles = filteredCycles.filter(cycle => getEolStatus(cycle.eol).text === selectedStatus);
                }

                // Then, filter by version if a query exists
                if (versionQuery) {
                    filteredCycles = filteredCycles.filter(cycle => cycle.cycle.toLowerCase().includes(versionQuery));
                }

                const header = document.createElement('h2');
                header.className = 'text-2xl font-bold mb-4 text-gray-800 capitalize';
                header.textContent = `${productName} Lifecycle`;
                productDetailsContainer.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

                if (filteredCycles.length === 0) {
                    grid.innerHTML = `<p class="text-gray-500 col-span-full">No versions match the current filters.</p>`;
                } else {
                    filteredCycles.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate)).forEach(cycle => {
                        const card = document.createElement('div');
                        const eolStatus = getEolStatus(cycle.eol);
                        card.className = `bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border ${eolStatus.borderColor}`;
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-semibold text-gray-900">Version ${cycle.cycle}</h3>
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${eolStatus.bgColor} ${eolStatus.textColor}">${eolStatus.text}</span>
                            </div>
                            <div class="mt-4 space-y-3 text-sm text-gray-600">
                                ${cycle.releaseDate ? `<p><strong>Release Date:</strong> ${formatDate(cycle.releaseDate)}</p>` : ''}
                                ${cycle.support ? `<p><strong>Active Support:</strong> ${formatDate(cycle.support)}</p>` : ''}
                                ${cycle.eol ? `<p><strong>End of Life:</strong> ${formatDate(cycle.eol)}</p>` : ''}
                                ${cycle.lts ? `<p class="font-semibold text-blue-600">Long Term Support (LTS)</p>` : ''}
                            </div>`;
                        grid.appendChild(card);
                    });
                }
                productDetailsContainer.appendChild(grid);
            };

            const getEolStatus = (eolDate) => {
                if (eolDate === false) return { text: 'Not Yet Scheduled', bgColor: 'bg-gray-200', textColor: 'text-gray-800', borderColor: 'border-gray-300' };
                if (eolDate === true) return { text: 'EOL', bgColor: 'bg-red-100', textColor: 'text-red-800', borderColor: 'border-red-300' };
                const today = new Date();
                const eol = new Date(eolDate);
                if (eol < today) return { text: 'End of Life', bgColor: 'bg-red-100', textColor: 'text-red-800', borderColor: 'border-red-300' };
                return { text: 'Supported', bgColor: 'bg-green-100', textColor: 'text-green-800', borderColor: 'border-green-300' };
            };

            const formatDate = (dateString) => {
                if (typeof dateString === 'boolean') return dateString ? 'Yes' : 'No';
                if (!dateString) return 'N/A';
                try {
                    return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                } catch(e) {
                    return dateString;
                }
            };

            const clearAllFilters = () => {
                productFilter.value = '';
                statusFilter.value = 'all';
                versionFilter.value = '';
                productSelect.value = 'Select a product';
                populateProductDropdown(allProducts);
                productDetailsContainer.innerHTML = '';
                initialMessage.classList.remove('hidden');
                // Clear URL parameters without reloading the page
                window.history.pushState({}, document.title, window.location.pathname);
            };

            // --- Event Listeners ---
            productSelect.addEventListener('change', (e) => {
                fetchProductDetails(e.target.value);
            });

            productFilter.addEventListener('input', (e) => {
                const filterText = e.target.value.toLowerCase();
                const filteredProducts = allProducts.filter(product => product.toLowerCase().includes(filterText));
                populateProductDropdown(filteredProducts);
            });

            statusFilter.addEventListener('change', (e) => {
                if (productSelect.value && productSelect.value !== 'Select a product') {
                    renderProductDetails(productSelect.value);
                }
            });

            versionFilter.addEventListener('input', (e) => {
                if (productSelect.value && productSelect.value !== 'Select a product') {
                    renderProductDetails(productSelect.value);
                }
            });

            clearFiltersBtn.addEventListener('click', clearAllFilters);

            // --- Main Initialization Logic ---
            const initializePage = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const productFromUrl = urlParams.get('product');
                const statusFromUrl = urlParams.get('status');
                const versionFromUrl = urlParams.get('version');

                if (productFromUrl) {
                    productFilter.value = productFromUrl;
                }
                if (statusFromUrl) {
                    statusFilter.value = statusFromUrl;
                }
                if (versionFromUrl) {
                    versionFilter.value = versionFromUrl;
                }

                try {
                    const response = await fetch('https://endoflife.date/api/all.json?_=' + new Date().getTime());
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allProducts = await response.json();

                    const currentFilter = productFilter.value.toLowerCase();
                    const productsToShow = currentFilter 
                        ? allProducts.filter(p => p.toLowerCase().includes(currentFilter))
                        : allProducts;
                    
                    populateProductDropdown(productsToShow);

                    if (currentFilter) {
                        const matchedProduct = allProducts.find(p => p.toLowerCase() === currentFilter);
                        if (matchedProduct) {
                            productSelect.value = matchedProduct;
                            fetchProductDetails(matchedProduct);
                        } else if (productsToShow.length === 0) {
                            console.warn(`Product "${currentFilter}" from URL parameter not found.`);
                            initialMessage.classList.add('hidden');
                            productDetailsContainer.innerHTML = `<div class="text-center text-yellow-600 p-10 border-2 border-dashed border-yellow-400 rounded-lg bg-yellow-50">
                                <p>The product specified, "<strong>${currentFilter}</strong>", could not be found. Please select a product from the list.</p>
                            </div>`;
                        }
                    }
                } catch (error) {
                    console.error("Failed to initialize page:", error);
                    productSelect.innerHTML = '<option selected disabled>Failed to load products</option>';
                }
            };

            initializePage();
        });
    </script>
</body>
</html>
